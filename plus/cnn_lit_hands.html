<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²½ëŸ‰í™” CNN ì†ë™ì‘ ì¸ì‹ê¸° (MobileNet V2)</title>
    <style>
        /* ìŠ¤íƒ€ì¼ ì •ì˜ */
        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif;
            background-color: #e0f2f1; 
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            margin: 0;
            color: #333;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            max-width: 800px;
            width: 100%;
            text-align: center;
        }

        h1 { margin-top: 0; color: #00695c; } 
        
        #video-wrapper {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin: 20px auto;
            border-radius: 15px;
            overflow: hidden;
            background-color: #000;
            aspect-ratio: 4/3;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        
        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1); 
        }

        #result-box {
            margin: 20px 0;
            padding: 15px;
            background-color: #e0f2f1;
            border-radius: 12px;
            border: 2px solid #26a69a;
        }
        #current-gesture {
            font-size: 2.5rem;
            font-weight: 800;
            color: #00897b;
            margin: 5px 0;
        }
        #confidence { font-size: 1.1rem; color: #555; }

        .class-grid-title { margin-top: 30px; font-weight: bold; color: #666; }
        .class-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .class-item {
            padding: 10px;
            background-color: #f1f3f5;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            color: #868e96;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        
        .class-item.active {
            background-color: #009688;
            color: white;
            transform: scale(1.05);
            border-color: #004d40;
            box-shadow: 0 4px 10px rgba(0, 150, 136, 0.3);
        }

        button {
            background-color: #00897b;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
        }
        button:hover { background-color: #00695c; }
        button:disabled { background-color: #b0bec5; cursor: not-allowed; }
        
        #status {
            margin-bottom: 15px;
            font-weight: bold;
            color: #e65100;
            background: #fff3e0;
            padding: 10px;
            border-radius: 8px;
            display: inline-block;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>ğŸ“± ê²½ëŸ‰í™” CNN ì†ë™ì‘ ì¸ì‹ê¸°</h1>
        <p>MobileNet V2 (9MB) ëª¨ë¸ì„ ì‚¬ìš©í•˜ì—¬<br>ë¹ ë¥´ê³  íš¨ìœ¨ì ìœ¼ë¡œ ë™ì‘ì„ ë¶„ë¥˜í•©ë‹ˆë‹¤.</p>

        <div id="status">ğŸ“¥ ëª¨ë¸ ë‹¤ìš´ë¡œë“œ ëŒ€ê¸° ì¤‘...</div>

        <div id="video-wrapper">
            <video id="webcam" autoplay playsinline muted></video>
        </div>

        <div id="result-box">
            <div>í˜„ì¬ ì¸ì‹ëœ ë™ì‘</div>
            <div id="current-gesture">-</div>
            <div id="confidence">ì •í™•ë„: 0%</div>
        </div>

        <button id="startBtn" disabled>ì¹´ë©”ë¼ ì¼œê¸°</button>

        <div class="class-grid-title">ê°ì§€ ê°€ëŠ¥í•œ ë™ì‘ ë¦¬ìŠ¤íŠ¸ (12ê°œ)</div>
        <div class="class-grid" id="classList"></div>
    </div>

    <script type="module">
        import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@huggingface/transformers@3.0.2';

        // ì„¤ì •: ë¡œì»¬ ëª¨ë¸ ì‚¬ìš© ì•ˆ í•¨ (ì„œë²„ì—ì„œ ë‹¤ìš´ë¡œë“œ)
        env.allowLocalModels = false;
        // ìºì‹œ ë¬¸ì œ ë°©ì§€ë¥¼ ìœ„í•´ ë¡œì»¬ ëª¨ë¸ ì‚¬ìš© ê¸ˆì§€ ì„¤ì • ê°•í™”
        env.useBrowserCache = false; 

        // 12ê°œ í´ë˜ìŠ¤ ë¦¬ìŠ¤íŠ¸
        const GESTURE_CLASSES = [
            "call", "dislike", "fist", "four", 
            "like", "mute", "ok", "one", 
            "palm", "peace", "peace_inverted", "rock"
        ];

        const statusEl = document.getElementById('status');
        const gestureEl = document.getElementById('current-gesture');
        const confEl = document.getElementById('confidence');
        const startBtn = document.getElementById('startBtn');
        const video = document.getElementById('webcam');
        const classListContainer = document.getElementById('classList');

        // ìº”ë²„ìŠ¤ ì„¤ì • (ë¹„ë””ì˜¤ -> ì´ë¯¸ì§€ ë³€í™˜ìš©)
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');

        let classifier = null;
        let isRunning = false;
        let lastLabel = "";

        function createClassList() {
            classListContainer.innerHTML = '';
            GESTURE_CLASSES.forEach(cls => {
                const div = document.createElement('div');
                div.className = 'class-item';
                div.id = `cls-${cls}`;
                div.innerText = cls.toUpperCase();
                classListContainer.appendChild(div);
            });
        }

        // 1. ëª¨ë¸ ë¡œë“œ í•¨ìˆ˜
        async function loadModel() {
            createClassList();
            statusEl.innerText = "â³ MobileNet V2 ëª¨ë¸ ë‹¤ìš´ë¡œë“œ ì¤‘...";
            
            try {
                // â˜… í•µì‹¬ ìˆ˜ì • ë¶€ë¶„: dtype: 'fp32' ì¶”ê°€ â˜…
                // ì´ ì„¤ì •ì´ ì—†ìœ¼ë©´ model_quantized.onnxë¥¼ ì°¾ìœ¼ë ¤ë‹¤ 404 ì—ëŸ¬ê°€ ë‚©ë‹ˆë‹¤.
                classifier = await pipeline('image-classification', 'gihakkk/hand_seperate_cnn_lit', {
                    dtype: 'fp32',   // ì›ë³¸ ëª¨ë¸(model.onnx)ì„ ì‚¬ìš©í•˜ë„ë¡ ê°•ì œ
                });

                statusEl.innerText = "âœ… ëª¨ë¸ ì¤€ë¹„ ì™„ë£Œ! (MobileNet V2)";
                statusEl.style.color = "#00695c";
                statusEl.style.backgroundColor = "#e0f2f1";
                startBtn.disabled = false;
            } catch (err) {
                console.error(err);
                statusEl.innerText = "âŒ ì˜¤ë¥˜ ë°œìƒ: " + err.message;
                alert("ëª¨ë¸ ë¡œë“œ ì‹¤íŒ¨! ì½˜ì†”(F12)ì„ í™•ì¸í•˜ì„¸ìš”.");
            }
        }

        // 2. ì›¹ìº  ì‹œì‘
        async function startWebcam() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                await video.play();

                video.onloadedmetadata = () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                };

                statusEl.innerText = "ğŸ‘€ ì‹¤ì‹œê°„ ë¶„ì„ ì¤‘...";
                startBtn.innerText = "ë¶„ì„ ì¤‘";
                startBtn.disabled = true;
                isRunning = true;
                
                predictLoop();
            } catch (err) {
                alert("ì¹´ë©”ë¼ ì ‘ê·¼ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”!");
            }
        }

        // 3. ê²°ê³¼ UI ì—…ë°ì´íŠ¸
        function updateUI(label, score) {
            gestureEl.innerText = label;
            confEl.innerText = `ì •í™•ë„: ${(score * 100).toFixed(1)}%`;

            if (lastLabel) {
                const prevItem = document.getElementById(`cls-${lastLabel}`);
                if (prevItem) prevItem.classList.remove('active');
            }

            const currentItem = document.getElementById(`cls-${label}`);
            if (currentItem) {
                currentItem.classList.add('active');
            }

            lastLabel = label;
        }

        // 4. ì˜ˆì¸¡ ë£¨í”„
        async function predictLoop() {
            if (!isRunning) return;

            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                try {
                    // ìº”ë²„ìŠ¤ í¬ê¸° ë™ê¸°í™”
                    if (canvas.width !== video.videoWidth) {
                         canvas.width = video.videoWidth;
                         canvas.height = video.videoHeight;
                    }
                    
                    // ë¹„ë””ì˜¤ -> ìº”ë²„ìŠ¤ -> ë°ì´í„° URL ë³€í™˜
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    const imageUrl = canvas.toDataURL('image/jpeg', 0.8);

                    // ì¶”ë¡  ì‹¤í–‰
                    const results = await classifier(imageUrl);
                    
                    if (results.length > 0) {
                        const top = results[0];
                        updateUI(top.label, top.score);
                    }
                } catch (e) {
                    console.error("Prediction Error:", e);
                }
            }

            requestAnimationFrame(predictLoop);
        }

        startBtn.addEventListener('click', startWebcam);
        loadModel();
    </script>
</body>
</html>