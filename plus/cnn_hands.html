<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CNN ì†ë™ì‘ ì¸ì‹ê¸° (ResNet-50)</title>
    <style>
        /* ìŠ¤íƒ€ì¼ ì •ì˜ (ì´ì „ê³¼ ë™ì¼í•œ ê¹”ë”í•œ ë””ìì¸) */
        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif;
            background-color: #eef2f6; /* ViT ë²„ì „ê³¼ êµ¬ë¶„ì„ ìœ„í•´ ë°°ê²½ìƒ‰ì„ ì‚´ì§ ë‹¤ë¥´ê²Œ ë³€ê²½ */
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            margin: 0;
            color: #333;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            max-width: 800px;
            width: 100%;
            text-align: center;
        }

        h1 { margin-top: 0; color: #1565c0; } /* CNN ë²„ì „ì€ íŒŒë€ìƒ‰ í…Œë§ˆ */
        
        #video-wrapper {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin: 20px auto;
            border-radius: 15px;
            overflow: hidden;
            background-color: #000;
            aspect-ratio: 4/3;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        
        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* ê±°ìš¸ ëª¨ë“œ */
        }

        #result-box {
            margin: 20px 0;
            padding: 15px;
            background-color: #e3f2fd; /* ê²°ê³¼ ë°•ìŠ¤ë„ íŒŒë€ìƒ‰ ê³„ì—´ */
            border-radius: 12px;
            border: 2px solid #2196f3;
        }
        #current-gesture {
            font-size: 2.5rem;
            font-weight: 800;
            color: #1565c0;
            margin: 5px 0;
        }
        #confidence { font-size: 1.1rem; color: #555; }

        .class-grid-title { margin-top: 30px; font-weight: bold; color: #666; }
        .class-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .class-item {
            padding: 10px;
            background-color: #f1f3f5;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            color: #868e96;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        
        /* í™œì„±í™”ëœ í´ë˜ìŠ¤ ìŠ¤íƒ€ì¼ (íŒŒë€ìƒ‰ ê°•ì¡°) */
        .class-item.active {
            background-color: #1976d2;
            color: white;
            transform: scale(1.05);
            border-color: #0d47a1;
            box-shadow: 0 4px 10px rgba(25, 118, 210, 0.3);
        }

        button {
            background-color: #1565c0;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
        }
        button:hover { background-color: #0d47a1; }
        button:disabled { background-color: #b0bec5; cursor: not-allowed; }
        
        #status {
            margin-bottom: 15px;
            font-weight: bold;
            color: #d84315;
            background: #fbe9e7;
            padding: 10px;
            border-radius: 8px;
            display: inline-block;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>ğŸ§  CNN ì†ë™ì‘ ì¸ì‹ê¸°</h1>
        <p>ResNet-50 ëª¨ë¸ì„ ì‚¬ìš©í•˜ì—¬ ì‹¤ì‹œê°„ìœ¼ë¡œ ë™ì‘ì„ ë¶„ë¥˜í•©ë‹ˆë‹¤.</p>

        <div id="status">ğŸ“¥ CNN ëª¨ë¸ ë‹¤ìš´ë¡œë“œ ëŒ€ê¸° ì¤‘...</div>

        <div id="video-wrapper">
            <video id="webcam" autoplay playsinline muted></video>
        </div>

        <div id="result-box">
            <div>í˜„ì¬ ì¸ì‹ëœ ë™ì‘</div>
            <div id="current-gesture">-</div>
            <div id="confidence">ì •í™•ë„: 0%</div>
        </div>

        <button id="startBtn" disabled>ì¹´ë©”ë¼ ì¼œê¸°</button>

        <div class="class-grid-title">ê°ì§€ ê°€ëŠ¥í•œ ë™ì‘ ë¦¬ìŠ¤íŠ¸ (12ê°œ)</div>
        <div class="class-grid" id="classList"></div>
    </div>

    <script type="module">
        import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2';

        // ì„¤ì •: ë¡œì»¬ ëª¨ë¸ ì‚¬ìš© ì•ˆ í•¨
        env.allowLocalModels = false;

        // 12ê°œ í´ë˜ìŠ¤ (í•™ìŠµëœ ìˆœì„œ)
        const GESTURE_CLASSES = [
            "call", "dislike", "fist", "four", 
            "like", "mute", "ok", "one", 
            "palm", "peace", "peace_inverted", "rock"
        ];

        // UI ìš”ì†Œ
        const statusEl = document.getElementById('status');
        const gestureEl = document.getElementById('current-gesture');
        const confEl = document.getElementById('confidence');
        const startBtn = document.getElementById('startBtn');
        const video = document.getElementById('webcam');
        const classListContainer = document.getElementById('classList');

        // ìº”ë²„ìŠ¤ ì„¤ì • (ë¹„ë””ì˜¤ -> ì´ë¯¸ì§€ ë³€í™˜ìš©)
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');

        let classifier = null;
        let isRunning = false;
        let lastLabel = "";

        // í´ë˜ìŠ¤ ëª©ë¡ UI ìƒì„±
        function createClassList() {
            classListContainer.innerHTML = '';
            GESTURE_CLASSES.forEach(cls => {
                const div = document.createElement('div');
                div.className = 'class-item';
                div.id = `cls-${cls}`;
                div.innerText = cls.toUpperCase();
                classListContainer.appendChild(div);
            });
        }

        // 1. CNN ëª¨ë¸ ë¡œë“œ
        async function loadModel() {
            createClassList();
            statusEl.innerText = "â³ CNN ëª¨ë¸(ResNet-50) ë¡œë”© ì¤‘... (ì•½ 100MB)";
            
            try {
                // â˜… ì—¬ê¸°ê°€ í•µì‹¬ ë³€ê²½ì : ëª¨ë¸ IDë¥¼ CNN ë²„ì „ìœ¼ë¡œ ë³€ê²½
                // 'onnx' í´ë” êµ¬ì¡°ë¥¼ ì˜ ë§ì¶°ì£¼ì…”ì„œ ë³„ë„ ê²½ë¡œ ì„¤ì • ì—†ì´ IDë§Œ ì ìœ¼ë©´ ë©ë‹ˆë‹¤.
                classifier = await pipeline('image-classification', 'gihakkk/hand_seperate_cnn', {
                    quantized: false // ì›ë³¸ ONNX ì‚¬ìš©
                });

                statusEl.innerText = "âœ… CNN ëª¨ë¸ ì¤€ë¹„ ì™„ë£Œ!";
                statusEl.style.color = "#1565c0";
                statusEl.style.backgroundColor = "#e3f2fd";
                startBtn.disabled = false;
            } catch (err) {
                console.error(err);
                statusEl.innerText = "âŒ ëª¨ë¸ ë¡œë“œ ì‹¤íŒ¨. ê°œë°œì ë„êµ¬(F12)ë¥¼ í™•ì¸í•˜ì„¸ìš”.";
            }
        }

        // 2. ì›¹ìº  ì‹œì‘
        async function startWebcam() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                await video.play();

                video.onloadedmetadata = () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                };

                statusEl.innerText = "ğŸ‘€ ResNetì´ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...";
                startBtn.innerText = "ë¶„ì„ ì¤‘";
                startBtn.disabled = true;
                isRunning = true;
                
                predictLoop();
            } catch (err) {
                alert("ì¹´ë©”ë¼ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”!");
            }
        }

        // 3. ê²°ê³¼ ì—…ë°ì´íŠ¸ (UI)
        function updateUI(label, score) {
            gestureEl.innerText = label;
            confEl.innerText = `ì •í™•ë„: ${(score * 100).toFixed(1)}%`;

            if (lastLabel) {
                const prevItem = document.getElementById(`cls-${lastLabel}`);
                if (prevItem) prevItem.classList.remove('active');
            }

            const currentItem = document.getElementById(`cls-${label}`);
            if (currentItem) {
                currentItem.classList.add('active');
            }

            lastLabel = label;
        }

        // 4. ì˜ˆì¸¡ ë£¨í”„
        async function predictLoop() {
            if (!isRunning) return;

            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                try {
                    // ìº”ë²„ìŠ¤ í¬ê¸° ë™ê¸°í™”
                    if (canvas.width !== video.videoWidth) {
                         canvas.width = video.videoWidth;
                         canvas.height = video.videoHeight;
                    }
                    
                    // ì´ë¯¸ì§€ë¥¼ ìº”ë²„ìŠ¤ì— ê·¸ë¦¬ê³  ë°ì´í„° ì¶”ì¶œ
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    const imageUrl = canvas.toDataURL('image/jpeg', 0.8);

                    // ì¶”ë¡  ì‹¤í–‰
                    const results = await classifier(imageUrl);
                    
                    if (results.length > 0) {
                        const top = results[0];
                        updateUI(top.label, top.score);
                    }
                } catch (e) {
                    console.error("Prediction Error:", e);
                }
            }

            // ë‹¤ìŒ í”„ë ˆì„ ìš”ì²­
            requestAnimationFrame(predictLoop);
        }

        // ì‹œì‘ ë²„íŠ¼ ì´ë²¤íŠ¸
        startBtn.addEventListener('click', startWebcam);

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ëª¨ë¸ ë‹¤ìš´ë¡œë“œ ì‹œì‘
        loadModel();
    </script>
</body>
</html>