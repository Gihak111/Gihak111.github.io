<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HaGRID ì†ë™ì‘ ì¸ì‹ê¸° (ViT)</title>
    <style>
        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif;
            background-color: #f4f6f9;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            margin: 0;
            color: #333;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            max-width: 800px;
            width: 100%;
            text-align: center;
        }

        h1 { margin-top: 0; color: #2c3e50; }
        
        #video-wrapper {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin: 20px auto;
            border-radius: 15px;
            overflow: hidden;
            background-color: #000;
            aspect-ratio: 4/3;
        }
        
        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }

        #result-box {
            margin: 20px 0;
            padding: 15px;
            background-color: #e8f5e9;
            border-radius: 12px;
            border: 2px solid #4caf50;
        }
        #current-gesture {
            font-size: 2.5rem;
            font-weight: 800;
            color: #2e7d32;
            margin: 5px 0;
        }
        #confidence { font-size: 1.1rem; color: #555; }

        .class-grid-title { margin-top: 30px; font-weight: bold; color: #666; }
        .class-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .class-item {
            padding: 10px;
            background-color: #f1f3f5;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            color: #868e96;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        
        .class-item.active {
            background-color: #2e7d32;
            color: white;
            transform: scale(1.05);
            border-color: #1b5e20;
            box-shadow: 0 4px 10px rgba(46, 125, 50, 0.3);
        }

        button {
            background-color: #339af0;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
        }
        button:hover { background-color: #228be6; }
        button:disabled { background-color: #adb5bd; cursor: not-allowed; }
        
        #status {
            margin-bottom: 15px;
            font-weight: bold;
            color: #e67e22;
            background: #fff3e0;
            padding: 10px;
            border-radius: 8px;
            display: inline-block;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>ğŸ–ï¸ AI ì†ë™ì‘ ì¸ì‹ê¸°</h1>
        <p>ì›¹ìº ì„ í†µí•´ ì‹¤ì‹œê°„ìœ¼ë¡œ ë™ì‘ì„ ë¶„ë¥˜í•©ë‹ˆë‹¤.</p>

        <div id="status">ğŸ“¥ ëª¨ë¸ ë‹¤ìš´ë¡œë“œ ëŒ€ê¸° ì¤‘...</div>

        <div id="video-wrapper">
            <video id="webcam" autoplay playsinline muted></video>
        </div>

        <div id="result-box">
            <div>í˜„ì¬ ì¸ì‹ëœ ë™ì‘</div>
            <div id="current-gesture">-</div>
            <div id="confidence">ì •í™•ë„: 0%</div>
        </div>

        <button id="startBtn" disabled>ì¹´ë©”ë¼ ì¼œê¸°</button>

        <div class="class-grid-title">ê°ì§€ ê°€ëŠ¥í•œ ë™ì‘ ë¦¬ìŠ¤íŠ¸ (12ê°œ)</div>
        <div class="class-grid" id="classList"></div>
    </div>

    <script type="module">
        import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2';

        env.allowLocalModels = false;

        const GESTURE_CLASSES = [
            "call", "dislike", "fist", "four", 
            "like", "mute", "ok", "one", 
            "palm", "peace", "peace_inverted", "rock"
        ];

        const statusEl = document.getElementById('status');
        const gestureEl = document.getElementById('current-gesture');
        const confEl = document.getElementById('confidence');
        const startBtn = document.getElementById('startBtn');
        const video = document.getElementById('webcam');
        const classListContainer = document.getElementById('classList');

        // ğŸ’¡ í•µì‹¬ ì¶”ê°€: ë¹„ë””ì˜¤ë¥¼ ì´ë¯¸ì§€ë¡œ ë³€í™˜í•˜ê¸° ìœ„í•œ ê°€ìƒì˜ ìº”ë²„ìŠ¤ ìƒì„±
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');

        let classifier = null;
        let isRunning = false;
        let lastLabel = "";

        function createClassList() {
            classListContainer.innerHTML = '';
            GESTURE_CLASSES.forEach(cls => {
                const div = document.createElement('div');
                div.className = 'class-item';
                div.id = `cls-${cls}`;
                div.innerText = cls.toUpperCase();
                classListContainer.appendChild(div);
            });
        }

        async function loadModel() {
            createClassList();
            statusEl.innerText = "â³ ëª¨ë¸ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘... (ìµœì´ˆ 1íšŒ ë‹¤ìš´ë¡œë“œ)";
            
            try {
                classifier = await pipeline('image-classification', 'gihakkk/hand_seperate_vit', {
                    quantized: false 
                });

                statusEl.innerText = "âœ… ëª¨ë¸ ì¤€ë¹„ ì™„ë£Œ!";
                statusEl.style.color = "#2e7d32";
                statusEl.style.backgroundColor = "#e8f5e9";
                startBtn.disabled = false;
            } catch (err) {
                console.error(err);
                statusEl.innerText = "âŒ ëª¨ë¸ ë¡œë“œ ì‹¤íŒ¨. ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.";
            }
        }

        async function startWebcam() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                await video.play();

                // ë¹„ë””ì˜¤ í¬ê¸°ì— ë§ì¶° ìº”ë²„ìŠ¤ í¬ê¸° ì„¤ì •
                video.onloadedmetadata = () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                };

                statusEl.innerText = "ğŸ‘€ ì‹¤ì‹œê°„ ë¶„ì„ ì¤‘...";
                startBtn.innerText = "ë¶„ì„ ì¤‘";
                startBtn.disabled = true;
                isRunning = true;
                
                predictLoop();
            } catch (err) {
                alert("ì›¹ìº  ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”!");
            }
        }

        function updateUI(label, score) {
            gestureEl.innerText = label;
            confEl.innerText = `ì •í™•ë„: ${(score * 100).toFixed(1)}%`;

            if (lastLabel) {
                const prevItem = document.getElementById(`cls-${lastLabel}`);
                if (prevItem) prevItem.classList.remove('active');
            }

            const currentItem = document.getElementById(`cls-${label}`);
            if (currentItem) {
                currentItem.classList.add('active');
            }

            lastLabel = label;
        }

        async function predictLoop() {
            if (!isRunning) return;

            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                try {
                    // ğŸ’¡ ìˆ˜ì •ëœ ë¶€ë¶„: ë¹„ë””ì˜¤ë¥¼ ìº”ë²„ìŠ¤ì— ê·¸ë¦¬ê³  -> Data URL(ì´ë¯¸ì§€ ë¬¸ìì—´)ë¡œ ë³€í™˜í•˜ì—¬ ì „ë‹¬
                    if (canvas.width !== video.videoWidth) {
                         canvas.width = video.videoWidth;
                         canvas.height = video.videoHeight;
                    }
                    
                    // 1. í˜„ì¬ ë¹„ë””ì˜¤ í”„ë ˆì„ì„ ìº”ë²„ìŠ¤ì— ê·¸ë¦¬ê¸°
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    
                    // 2. ìº”ë²„ìŠ¤ ì´ë¯¸ì§€ë¥¼ base64 ë¬¸ìì—´ë¡œ ë³€í™˜ (AIê°€ ì´í•´í•  ìˆ˜ ìˆëŠ” ì´ë¯¸ì§€ í˜•ì‹)
                    const imageUrl = canvas.toDataURL('image/jpeg', 0.8);

                    // 3. ë³€í™˜ëœ ì´ë¯¸ì§€ë¥¼ ëª¨ë¸ì— ì „ë‹¬
                    const results = await classifier(imageUrl);
                    
                    if (results.length > 0) {
                        const top = results[0];
                        updateUI(top.label, top.score);
                    }
                } catch (e) {
                    console.error("Prediction Error:", e);
                    // ì—ëŸ¬ê°€ ë‚˜ë„ ë©ˆì¶”ì§€ ì•Šë„ë¡ ì²˜ë¦¬
                }
            }

            // ì•½ê°„ì˜ ë”œë ˆì´ë¥¼ ì£¼ì–´ ë¸Œë¼ìš°ì € ë¶€í•˜ë¥¼ ì¤„ì„ (í•„ìš”ì‹œ setTimeout ì‚¬ìš© ê°€ëŠ¥)
            requestAnimationFrame(predictLoop);
        }

        startBtn.addEventListener('click', startWebcam);
        loadModel();
    </script>
</body>
</html>