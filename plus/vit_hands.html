<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HaGRID ì†ë™ì‘ ì¸ì‹ê¸° (ViT)</title>
    <style>
        /* ìŠ¤íƒ€ì¼ ì •ì˜ */
        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif;
            background-color: #f4f6f9;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            margin: 0;
            color: #333;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            max-width: 800px;
            width: 100%;
            text-align: center;
        }

        h1 { margin-top: 0; color: #2c3e50; }
        
        /* ë¹„ë””ì˜¤ ì˜ì—­ */
        #video-wrapper {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin: 20px auto;
            border-radius: 15px;
            overflow: hidden;
            background-color: #000;
            aspect-ratio: 4/3;
        }
        
        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* ê±°ìš¸ ëª¨ë“œ */
        }

        /* ê²°ê³¼ í‘œì‹œ ì˜ì—­ */
        #result-box {
            margin: 20px 0;
            padding: 15px;
            background-color: #e8f5e9;
            border-radius: 12px;
            border: 2px solid #4caf50;
        }
        #current-gesture {
            font-size: 2.5rem;
            font-weight: 800;
            color: #2e7d32;
            margin: 5px 0;
        }
        #confidence { font-size: 1.1rem; color: #555; }

        /* í´ë˜ìŠ¤ ëª©ë¡ ê·¸ë¦¬ë“œ */
        .class-grid-title { margin-top: 30px; font-weight: bold; color: #666; }
        .class-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .class-item {
            padding: 10px;
            background-color: #f1f3f5;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            color: #868e96;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        
        /* í™œì„±í™”ëœ í´ë˜ìŠ¤ ìŠ¤íƒ€ì¼ */
        .class-item.active {
            background-color: #2e7d32;
            color: white;
            transform: scale(1.05);
            border-color: #1b5e20;
            box-shadow: 0 4px 10px rgba(46, 125, 50, 0.3);
        }

        /* ë²„íŠ¼ ë° ìƒíƒœ */
        button {
            background-color: #339af0;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
        }
        button:hover { background-color: #228be6; }
        button:disabled { background-color: #adb5bd; cursor: not-allowed; }
        
        #status {
            margin-bottom: 15px;
            font-weight: bold;
            color: #e67e22;
            background: #fff3e0;
            padding: 10px;
            border-radius: 8px;
            display: inline-block;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>ğŸ–ï¸ AI ì†ë™ì‘ ì¸ì‹ê¸°</h1>
        <p>ì›¹ìº ì„ í†µí•´ ì‹¤ì‹œê°„ìœ¼ë¡œ ë™ì‘ì„ ë¶„ë¥˜í•©ë‹ˆë‹¤.</p>

        <div id="status">ğŸ“¥ ëª¨ë¸ ë‹¤ìš´ë¡œë“œ ëŒ€ê¸° ì¤‘...</div>

        <div id="video-wrapper">
            <video id="webcam" autoplay playsinline muted></video>
        </div>

        <div id="result-box">
            <div>í˜„ì¬ ì¸ì‹ëœ ë™ì‘</div>
            <div id="current-gesture">-</div>
            <div id="confidence">ì •í™•ë„: 0%</div>
        </div>

        <button id="startBtn" disabled>ì¹´ë©”ë¼ ì¼œê¸°</button>

        <div class="class-grid-title">ê°ì§€ ê°€ëŠ¥í•œ ë™ì‘ ë¦¬ìŠ¤íŠ¸ (12ê°œ)</div>
        <div class="class-grid" id="classList">
            </div>
    </div>

    <script type="module">
        import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2';

        // ì„¤ì •: ë¡œì»¬ ëª¨ë¸ ì‚¬ìš© ì•ˆ í•¨, í—ˆê¹…í˜ì´ìŠ¤ì—ì„œ ì§ì ‘ ë‹¤ìš´ë¡œë“œ
        env.allowLocalModels = false;

        // 12ê°œ í´ë˜ìŠ¤ ëª©ë¡ (í•™ìŠµì‹œì¼°ë˜ ìˆœì„œì™€ ë¼ë²¨)
        // ì£¼ì˜: ì‹¤ì œ ëª¨ë¸ì˜ id2label ìˆœì„œê°€ ë‹¤ë¥¼ ê²½ìš° ìˆ˜ì •ì´ í•„ìš”í•  ìˆ˜ ìˆìœ¼ë‚˜, 
        // ë³´í†µ pipelineì´ ìë™ìœ¼ë¡œ ì²˜ë¦¬í•´ì¤ë‹ˆë‹¤. ì—¬ê¸°ì„  UI í‘œì‹œìš©ì…ë‹ˆë‹¤.
        const GESTURE_CLASSES = [
            "call", "dislike", "fist", "four", 
            "like", "mute", "ok", "one", 
            "palm", "peace", "peace_inverted", "rock"
        ];

        // UI ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
        const statusEl = document.getElementById('status');
        const gestureEl = document.getElementById('current-gesture');
        const confEl = document.getElementById('confidence');
        const startBtn = document.getElementById('startBtn');
        const video = document.getElementById('webcam');
        const classListContainer = document.getElementById('classList');

        let classifier = null;
        let isRunning = false;
        let lastLabel = "";

        // 1. í´ë˜ìŠ¤ ëª©ë¡ UI ìƒì„± í•¨ìˆ˜
        function createClassList() {
            classListContainer.innerHTML = '';
            GESTURE_CLASSES.forEach(cls => {
                const div = document.createElement('div');
                div.className = 'class-item';
                div.id = `cls-${cls}`; // ID ë¶€ì—¬ (ë‚˜ì¤‘ì— ì°¾ê¸° ìœ„í•´)
                div.innerText = cls.toUpperCase();
                classListContainer.appendChild(div);
            });
        }

        // 2. ëª¨ë¸ ë¡œë“œ í•¨ìˆ˜
        async function loadModel() {
            createClassList(); // ëª©ë¡ ë¨¼ì € í‘œì‹œ
            statusEl.innerText = "â³ ëª¨ë¸ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘... (ìµœì´ˆ 1íšŒ ë‹¤ìš´ë¡œë“œ)";
            
            try {
                // ì‘ì„±ìë‹˜ì˜ ëª¨ë¸ ID
                // quantized: falseë¥¼ ì£¼ì–´ ì›ë³¸ onnx(float32)ë¥¼ ì‚¬ìš©í•˜ë„ë¡ í•¨
                classifier = await pipeline('image-classification', 'gihakkk/hand_seperate_vit', {
                    quantized: false 
                });

                statusEl.innerText = "âœ… ëª¨ë¸ ì¤€ë¹„ ì™„ë£Œ!";
                statusEl.style.color = "#2e7d32";
                statusEl.style.backgroundColor = "#e8f5e9";
                startBtn.disabled = false;
            } catch (err) {
                console.error(err);
                statusEl.innerText = "âŒ ëª¨ë¸ ë¡œë“œ ì‹¤íŒ¨. ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.";
            }
        }

        // 3. ì›¹ìº  ì‹œì‘
        async function startWebcam() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                await video.play();

                statusEl.innerText = "ğŸ‘€ ì‹¤ì‹œê°„ ë¶„ì„ ì¤‘...";
                startBtn.innerText = "ë¶„ì„ ì¤‘";
                startBtn.disabled = true;
                isRunning = true;
                
                predictLoop();
            } catch (err) {
                alert("ì›¹ìº  ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”!");
            }
        }

        // 4. í™”ë©´ ì—…ë°ì´íŠ¸ (í´ë˜ìŠ¤ í•˜ì´ë¼ì´íŠ¸)
        function updateUI(label, score) {
            // í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
            gestureEl.innerText = label;
            confEl.innerText = `ì •í™•ë„: ${(score * 100).toFixed(1)}%`;

            // ì´ì „ í•˜ì´ë¼ì´íŠ¸ ì œê±°
            if (lastLabel) {
                const prevItem = document.getElementById(`cls-${lastLabel}`);
                if (prevItem) prevItem.classList.remove('active');
            }

            // ìƒˆ í•˜ì´ë¼ì´íŠ¸ ì¶”ê°€
            const currentItem = document.getElementById(`cls-${label}`);
            if (currentItem) {
                currentItem.classList.add('active');
            }

            lastLabel = label;
        }

        // 5. ì˜ˆì¸¡ ë£¨í”„
        async function predictLoop() {
            if (!isRunning) return;

            // ë¹„ë””ì˜¤ í”„ë ˆì„ì´ ì¤€ë¹„ë˜ì—ˆì„ ë•Œë§Œ ìˆ˜í–‰
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                try {
                    const results = await classifier(video);
                    
                    if (results.length > 0) {
                        const top = results[0];
                        // ì •í™•ë„ê°€ ë„ˆë¬´ ë‚®ìœ¼ë©´(ì˜ˆ: 10% ë¯¸ë§Œ) ë¬´ì‹œí•  ìˆ˜ë„ ìˆìŒ
                        updateUI(top.label, top.score);
                    }
                } catch (e) {
                    console.error("Prediction Error:", e);
                }
            }

            // ë‹¤ìŒ í”„ë ˆì„ ìš”ì²­
            requestAnimationFrame(predictLoop);
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²°
        startBtn.addEventListener('click', startWebcam);

        // ì‹œì‘ ì‹œ ëª¨ë¸ ë¡œë“œ
        loadModel();
    </script>
</body>
</html>