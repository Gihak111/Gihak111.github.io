<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>가맹점 찾기 - 지역화폐 사용 가능 업소</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Link to external stylesheet -->
    <link rel="stylesheet" href="styles.css">
</head>
<body class="bg-gray-900">
    <!-- Main container with flex layout -->
    <div class="flex h-screen">
        <!-- Sidebar -->
        <div class="sidebar p-4 flex flex-col w-1/4">
            <h1 class="text-2xl font-bold mb-4 text-center text-white">가맹점 찾기</h1>
            <p class="text-sm text-gray-400 mb-4 text-center">지역화폐 사용 가능 업소</p>
            <!-- Province selection -->
            <select id="provinceSelect" class="w-full p-2 mb-4 bg-gray-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">시/도 선택</option>
                <option value="Seoul">서울</option>
                <option value="Busan_Metropolitan_City">부산광역시</option>
                <option value="Chungcheongnam-do">충청남도</option>
                <option value="Gangwon_Special_Self-Governing_Province">강원도</option>
                <option value="Gwangju">광주</option>
                <option value="Gyeonggi-do">경기도</option>
                <option value="Gyeongsangbuk-do">경상북도</option>
                <option value="Gyeongsangnam-do">경상남도</option>
                <option value="Incheon">인천</option>
                <option value="Jeollabuk-do">전라북도</option>
                <option value="Jeollanam-do">전라남도</option>
                <option value="Jeonbuk">전북</option>
                <option value="Ulsan">울산</option>
            </select>
            <!-- City (District) selection -->
            <select id="citySelect" class="w-full p-2 mb-4 bg-gray-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
                <option value="">시군구 선택</option>
            </select>
            <!-- Category selection -->
            <select id="categorySelect" class="w-full p-2 mb-4 bg-gray-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
                <option value="all">모든 업종</option>
                <!-- Categories will be populated dynamically from categories.json -->
            </select>
            <!-- Search bar -->
            <input type="text" id="searchInput" placeholder="가맹점 이름 검색..." class="w-full p-2 mb-4 bg-gray-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            <!-- Business list -->
            <div id="businessList" class="space-y-2 overflow-y-auto"></div>
        </div>
        <!-- Map container -->
        <div id="map" class="flex-1"></div>
    </div>

    <!-- Review Modal -->
    <div id="reviewModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
        <div class="bg-gray-800 p-6 rounded-lg w-96">
            <h2 class="text-lg font-semibold text-white mb-4">리뷰 작성</h2>
            <div class="mb-4">
                <label class="block text-sm text-gray-300 mb-2">별점</label>
                <select id="reviewRating" class="w-full p-2 bg-gray-700 text-white rounded-lg">
                    <option value="5">★★★★★ 5</option>
                    <option value="4">★★★★☆ 4</option>
                    <option value="3">★★★☆☆ 3</option>
                    <option value="2">★★☆☆☆ 2</option>
                    <option value="1">★☆☆☆☆ 1</option>
                </select>
            </div>
            <div class="mb-4">
                <label class="block text-sm text-gray-300 mb-2">리뷰</label>
                <textarea id="reviewText" class="w-full p-2 bg-gray-700 text-white rounded-lg" rows="4" placeholder="리뷰를 입력하세요 (선택)"></textarea>
            </div>
            <div class="flex justify-end space-x-2">
                <button id="cancelReview" class="px-4 py-2 bg-gray-600 text-white rounded-lg">취소</button>
                <button id="submitReview" class="px-4 py-2 bg-blue-500 text-white rounded-lg">제출</button>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        // Caches for geocoded addresses and place IDs
        const addressCache = {};
        const placeIdCache = {};

        // Initialize PlacesService
        let placesService;

        // Geocode address using Google Geocoding API
        async function geocodeAddress(address) {
            if (!address) return null;
            if (addressCache[address]) {
                console.log(`Cache hit for address: ${address}`);
                return addressCache[address];
            }
            try {
                const apiKey = 'AIzaSyDkrKNG7uHZAIid7yg1nUnRA4K25PPKubA';
                const response = await fetch(`https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(address)}&key=${apiKey}`);
                if (!response.ok) {
                    throw new Error(`Geocoding HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                if (data.results && data.results[0]) {
                    const location = data.results[0].geometry.location;
                    const coordinates = { lat: location.lat, lng: location.lng };
                    addressCache[address] = coordinates;
                    console.log(`Geocoded address: ${address} -> ${JSON.stringify(coordinates)}`);
                    return coordinates;
                }
                console.warn(`No geocoding results for address: ${address}`);
                return null;
            } catch (error) {
                console.error('Geocoding error:', error);
                return null;
            }
        }

        // Find Place ID using PlacesService
        async function findPlaceId(businessName, address, cityCenter) {
            const query = `${businessName} ${address}`;
            if (placeIdCache[query]) {
                console.log(`Cache hit for place ID: ${query}`);
                return placeIdCache[query];
            }
            return new Promise((resolve, reject) => {
                if (!placesService) {
                    console.error('PlacesService not initialized');
                    resolve(null);
                    return;
                }
                const request = {
                    query: query,
                    fields: ['place_id'],
                    locationBias: cityCenter ? { lat: cityCenter.lat, lng: cityCenter.lng } : undefined
                };
                placesService.textSearch(request, (results, status) => {
                    if (status === google.maps.places.PlacesServiceStatus.OK && results && results[0]) {
                        const placeId = results[0].place_id;
                        placeIdCache[query] = placeId;
                        console.log(`Found place ID for ${query}: ${placeId}`);
                        resolve(placeId);
                    } else {
                        console.warn(`No place ID found for: ${query}, status: ${status}`);
                        resolve(null);
                    }
                });
            });
        }

        // Fetch Google Reviews using PlacesService
        async function fetchGoogleReviews(placeId) {
            if (!placeId) {
                console.log('No place ID provided for reviews');
                return [];
            }
            return new Promise((resolve, reject) => {
                if (!placesService) {
                    console.error('PlacesService not initialized');
                    resolve([]);
                    return;
                }
                const request = {
                    placeId: placeId,
                    fields: ['reviews'],
                    language: 'ko'
                };
                placesService.getDetails(request, (place, status) => {
                    if (status === google.maps.places.PlacesServiceStatus.OK && place.reviews) {
                        const reviews = place.reviews.map(review => ({
                            rating: review.rating,
                            text: review.text || '리뷰 내용 없음',
                            author: review.author_name || '익명',
                            source: 'Google'
                        }));
                        console.log(`Fetched ${reviews.length} reviews for place ID: ${placeId}`);
                        resolve(reviews);
                    } else {
                        console.log(`No reviews found for place ID: ${placeId}, status: ${status}`);
                        resolve([]);
                    }
                });
            });
        }

        // Load user reviews from localStorage
        function loadUserReviews(province, city, businessName) {
            const key = `reviews_${province}_${city}_${businessName}`;
            const reviews = localStorage.getItem(key);
            return reviews ? JSON.parse(reviews) : [];
        }

        // Save user review to localStorage
        function saveUserReview(province, city, businessName, review) {
            const key = `reviews_${province}_${city}_${businessName}`;
            const existingReviews = loadUserReviews(province, city, businessName);
            existingReviews.push(review);
            localStorage.setItem(key, JSON.stringify(existingReviews));
        }

        // Truncate text for display
        function truncateText(text, maxLength = 50) {
            return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
        }

        // Existing loadFileData function (unchanged)
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
            return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
            if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
                try {
                    var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                    var firstSheetName = workbook.SheetNames[0];
                    var worksheet = workbook.Sheets[firstSheetName];
                    var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                    var filteredData = jsonData.filter(row => row.some(filledCell));
                    var headerRowIndex = filteredData.findIndex((row, index) =>
                        row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                    );
                    if (headerRowIndex === -1 || headerRowIndex > 25) {
                        headerRowIndex = 0;
                    }
                    var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex));
                    csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                    return csv;
                } catch (e) {
                    console.error(e);
                    return "";
                }
            }
            return gk_fileData[filename] || "";
        }

        // Category mapping
        let categoryMap = {};

        // Predefined category options
        const categoryOptions = [
            { value: "기타", display: "기타" },
            { value: "음식점", display: "음식점" },
            { value: "슈퍼/마트", display: "슈퍼/마트" },
            { value: "카페/베이커리", display: "카페/베이커리" },
            { value: "부동산/인테리어", display: "부동산/인테리어" },
            { value: "학원/교육", display: "학원/교육" },
            { value: "자동차/자전거", display: "자동차/자전거" },
            { value: "의류/잡화/안경", display: "의류/잡화/안경" },
            { value: "스포츠/헬스", display: "스포츠/헬스" },
            { value: "미용/뷰티/위생", display: "미용/뷰티/위생" },
            { value: "병원/약국", display: "병원/약국" },
            { value: "가전/통신", display: "가전/통신" },
            { value: "도서/문화/공연", display: "도서/문화/공연" },
            { value: "주유소", display: "주유소" },
            { value: "숙박/캠핑", display: "숙박/캠핑" }
        ];

        // Populate categories from categories.json
        async function populateCategories() {
            const categorySelect = document.getElementById("categorySelect");
            try {
                const response = await fetch('./categories.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                if (!data.categories || !Array.isArray(data.categories)) {
                    throw new Error("Invalid data format: 'categories' array not found");
                }

                data.categories.forEach(category => {
                    categoryMap[category.name] = category.items;
                });

                categoryOptions.forEach(option => {
                    const opt = document.createElement("option");
                    opt.value = option.value;
                    opt.textContent = option.display;
                    categorySelect.appendChild(opt);
                });

                categoryOptions.forEach(option => {
                    if (!categoryMap[option.value]) {
                        categoryMap[option.value] = [];
                    }
                });

                const province = document.getElementById("provinceSelect").value;
                if (province) {
                    categorySelect.disabled = false;
                }
            } catch (error) {
                console.error('카테고리 로드 오류:', error);
                categoryOptions.forEach(option => {
                    const opt = document.createElement("option");
                    opt.value = option.value;
                    opt.textContent = option.display;
                    categorySelect.appendChild(opt);
                });
            }
        }

        // Function to get mock coordinates (for fallback)
        function getMockCoordinates(cityKey) {
            const cities = {
                "Seoul_강서구": { lat: 37.5516, lng: 126.8622 },
                "Seoul_중랑구": { lat: 37.5932, lng: 127.0867 },
                "Busan_Metropolitan_City_사상구": { lat: 35.1537, lng: 128.9767 },
                "Chungcheongnam-do_태안군": { lat: 36.7452, lng: 126.2982 },
                "Chungcheongnam-do_홍성군": { lat: 36.6000, lng: 126.6500 },
                "Chungcheongnam-do_천안시": { lat: 36.8145, lng: 127.1125 },
                "Gangwon_Special_Self-Governing_Province_강릉시": { lat: 37.7519, lng: 128.8760 },
                "Gangwon_Special_Self-Governing_Province_삼척시": { lat: 37.4400, lng: 129.1650 },
                "Gangwon_Special_Self-Governing_Province_동해시": { lat: 37.5244, lng: 129.1176 },
                "Gangwon_Special_Self-Governing_Province_태백시": { lat: 37.1747, lng: 128.9897 },
                "Gangwon_Special_Self-Governing_Province_영월군": { lat: 37.1833, lng: 128.4500 },
                "Gangwon_Special_Self-Governing_Province_홍천군": { lat: 37.6833, lng: 127.8833 },
                "Gangwon_Special_Self-Governing_Province_원주시": { lat: 37.3411, lng: 127.9345 },
                "Gangwon_Special_Self-Governing_Province_춘천시": { lat: 37.8814, lng: 127.7296 },
                "Gangwon_Special_Self-Governing_Province_정선군": { lat: 37.3800, lng: 128.6500 },
                "Gangwon_Special_Self-Governing_Province_속초시": { lat: 38.2080, lng: 128.5900 },
                "Gangwon_Special_Self-Governing_Province_화천군": { lat: 38.1083, lng: 127.7167 },
                "Gangwon_Special_Self-Governing_Province_횡성군": { lat: 37.4833, lng: 127.9833 },
                "Gangwon_Special_Self-Governing_Province_양양군": { lat: 38.0833, lng: 128.6167 },
                "Gangwon_Special_Self-Governing_Province_평창군": { lat: 37.3667, lng: 128.3833 },
                "Gangwon_Special_Self-Governing_Province_철원군": { lat: 38.1500, lng: 127.3167 },
                "Gangwon_Special_Self-Governing_Province_양구군": { lat: 38.1167, lng: 127.9833 },
                "Gangwon_Special_Self-Governing_Province_인제군": { lat: 38.0667, lng: 128.1667 },
                "Gangwon_Special_Self-Governing_Province_고성군": { lat: 38.3833, lng: 128.4667 },
                "Gwangju_광산구": { lat: 35.1500, lng: 126.8500 },
                "Gwangju_서구": { lat: 35.1537, lng: 126.8526 },
                "Gwangju_북구": { lat: 35.1778, lng: 126.9131 },
                "Gwangju_남구": { lat: 35.1361, lng: 126.9050 },
                "Gwangju_동구": { lat: 35.1428, lng: 126.9236 },
                "Gyeonggi-do_군포시": { lat: 37.3614, lng: 126.9350 },
                "Gyeonggi-do_남양주시": { lat: 37.6333, lng: 127.2167 },
                "Gyeonggi-do_안성시": { lat: 37.0083, lng: 127.2833 },
                "Gyeonggi-do_포천시": { lat: 38.1000, lng: 127.2000 },
                "Gyeonggi-do_여주시": { lat: 37.3000, lng: 127.6333 },
                "Gyeonggi-do_부천시": { lat: 37.4989, lng: 126.7660 },
                "Gyeonggi-do_안양시": { lat: 37.3924, lng: 126.9555 },
                "Gyeonggi-do_연천군": { lat: 38.0833, lng: 127.0833 },
                "Gyeonggi-do_수원시": { lat: 37.2833, lng: 127.0000 },
                "Gyeonggi-do_고양시": { lat: 37.6564, lng: 126.8320 },
                "Gyeonggi-do_용인시": { lat: 37.2418, lng: 127.1772 },
                "Gyeonggi-do_안산시": { lat: 37.3219, lng: 126.8306 },
                "Gyeongsangbuk-do_경산시": { lat: 35.8250, lng: 128.7333 },
                "Gyeongsangbuk-do_울진군": { lat: 36.9833, lng: 129.4000 },
                "Gyeongsangbuk-do_고령군": { lat: 35.7167, lng: 128.2667 },
                "Gyeongsangbuk-do_영주시": { lat: 36.8333, lng: 128.6167 },
                "Gyeongsangnam-do_창원시": { lat: 35.2278, lng: 128.6828 },
                "Gyeongsangnam-do_함양군": { lat: 35.5167, lng: 127.7167 },
                "Gyeongsangnam-do_진주시": { lat: 35.1800, lng: 128.1000 },
                "Gyeongsangnam-do_김해시": { lat: 35.2333, lng: 128.8833 },
                "Incheon_부평구": { lat: 37.5075, lng: 126.7236 },
                "Incheon_연수구": { lat: 37.4050, lng: 126.6811 },
                "Incheon_강화군": { lat: 37.7500, lng: 126.4833 },
                "Incheon_계양구": { lat: 37.5750, lng: 126.7361 },
                "Incheon_서구": { lat: 37.5578, lng: 126.6583 },
                "Incheon_미추홀구": { lat: 37.4700, lng: 126.6750 },
                "Incheon_동구": { lat: 37.4750, lng: 126.6400 },
                "Incheon_중구": { lat: 37.4736, lng: 126.6278 },
                "Incheon_남동구": { lat: 37.4514, lng: 126.7292 },
                "Incheon_옹진군": { lat: 37.2833, lng: 126.3833 },
                "Jeollabuk-do_고창군": { lat: 35.4333, lng: 126.7167 },
                "Jeollanam-do_보성군": { lat: 34.7700, lng: 127.0800 },
                "Jeollanam-do_광양시": { lat: 34.9400, lng: 127.7000 },
                "Jeollanam-do_신안군": { lat: 34.8333, lng: 126.1000 },
                "Jeonbuk_남원시": { lat: 35.4167, lng: 127.3833 },
                "Jeonbuk_익산시": { lat: 35.9500, lng: 127.0167 },
                "Ulsan_울주군": { lat: 35.5500, lng: 129.2000 },
                "Ulsan_중구": { lat: 35.5650, lng: 129.3400 },
                "Ulsan_남구": { lat: 35.5400, lng: 129.3200 },
                "Ulsan_북구": { lat: 35.5800, lng: 129.3500 },
                "Ulsan_동구": { lat: 35.5250, lng: 129.4300 }
            };
            const base = cities[cityKey] || { lat: 36.0, lng: 127.5 };
            const offset = 0.01 * (Math.random() - 0.5);
            return { lat: base.lat + offset, lng: base.lng + offset };
        }

        // Initialize empty map and PlacesService
        let map;
        function initEmptyMap() {
            const defaultCenter = { lat: 36.0, lng: 127.5 };
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 7,
                center: defaultCenter,
                mapTypeControl: false,
                streetViewControl: false,
                fullscreenControl: true,
                styles: [
                    { featureType: "all", elementType: "all", stylers: [{ saturation: -20 }, { lightness: 10 }] },
                    { featureType: "poi", elementType: "labels", stylers: [{ visibility: "simplified" }] },
                ],
            });
            placesService = new google.maps.places.PlacesService(map);
            return map;
        }

        // Load map with selected city and category data
        async function loadCityMap(province, city, category) {
            let businesses = [];
            if (!city) {
                console.log("시군구가 선택되지 않음");
                return;
            }

            try {
                const response = await fetch(`split_json/${province}.json`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                if (!data.records || !Array.isArray(data.records)) {
                    throw new Error("잘못된 데이터 형식: 'records' 배열 없음");
                }
                // Get city center for location bias
                const cityCenter = getMockCoordinates(`${province}_${city}`);
                // Filter records and process geocoding/reviews
                businesses = await Promise.all(
                    data.records
                        .filter(record => record["시군구명"] === city && (category === "all" || categoryMap[category].includes(record["업종명"])))
                        .map(async record => {
                            const address = record["소재지도로명주소"];
                            const coordinates = address ? await geocodeAddress(address) : null;
                            const placeId = address ? await findPlaceId(record["가맹점명"], address, cityCenter) : null;
                            const googleReviews = placeId ? await fetchGoogleReviews(placeId) : [];
                            const userReviews = loadUserReviews(province, city, record["가맹점명"]);
                            return {
                                name: record["가맹점명"],
                                category: record["업종명"],
                                localCurrency: record["사용가능지역화폐"],
                                address: address,
                                lat: coordinates ? coordinates.lat : getMockCoordinates(`${province}_${city}`).lat,
                                lng: coordinates ? coordinates.lng : getMockCoordinates(`${province}_${city}`).lng,
                                dataDate: record["데이터기준일자"],
                                provider: record["제공기관명"],
                                googleReviews: googleReviews,
                                userReviews: userReviews
                            };
                        })
                );
                if (businesses.length === 0) {
                    console.log(`No records found for ${city} with category ${category} in ${province}.json`);
                }
            } catch (error) {
                console.error('시군구 데이터 로드 오류:', error);
                return;
            }

            // Clear existing markers and business list
            const businessList = document.getElementById("businessList");
            businessList.innerHTML = "";
            if (map.markers) map.markers.forEach(marker => marker.setMap(null));
            map.markers = [];

            // Update map center and zoom
            const centerLat = businesses.length > 0 ? businesses[0].lat : getMockCoordinates(`${province}_${city}`).lat;
            const centerLng = businesses.length > 0 ? businesses[0].lng : getMockCoordinates(`${province}_${city}`).lng;
            map.setCenter({ lat: centerLat, lng: centerLng });
            map.setZoom(11);

            // Create markers and business items
            const infoWindows = [];
            businesses.forEach((business, index) => {
                const marker = new google.maps.Marker({
                    position: { lat: business.lat, lng: business.lng },
                    map: map,
                    title: business.name,
                    icon: { url: "http://maps.google.com/mapfiles/ms/icons/red-dot.png" },
                });
                map.markers.push(marker);

                // Prepare Google reviews HTML for info window
                let googleReviewsHtml = business.googleReviews.length > 0
                    ? `<h3 class="text-md font-semibold mb-2 text-white">Google 리뷰</h3>` +
                      business.googleReviews.map(review => `
                        <h5 class="text-sm text-gray-300 mb-1">
                            <span class="text-yellow-400">${"★".repeat(review.rating)}${"☆".repeat(5 - review.rating)}</span>
                            <span class="ml-2">${review.rating}.0</span> - 
                            "${truncateText(review.text)}" (Google - ${review.author})
                        </h5>
                      `).join("")
                    : `<h3 class="text-md font-semibold mb-2 text-white">Google 리뷰</h3><p class="text-sm text-gray-300">Google 리뷰가 없습니다.</p>`;

                // Prepare User reviews HTML for info window
                let userReviewsHtml = business.userReviews.length > 0
                    ? `<h3 class="text-md font-semibold mb-2 mt-4 text-white">사용자 리뷰</h3>` +
                      business.userReviews.map(review => `
                        <h5 class="text-sm text-gray-300 mb-1">
                            <span class="text-yellow-400">${"★".repeat(review.rating)}${"☆".repeat(5 - review.rating)}</span>
                            <span class="ml-2">${review.rating}.0</span> - 
                            "${truncateText(review.text)}" (User - 익명)
                        </h5>
                      `).join("")
                    : `<h3 class="text-md font-semibold mb-2 mt-4 text-white">사용자 리뷰</h3><p class="text-sm text-gray-300">사용자 리뷰가 없습니다.</p>`;

                // Info window content
                const infoContent = `
                    <div class="text-gray-100 max-w-xs">
                        <h2 class="text-lg font-semibold mb-2">${business.name}</h2>
                        <p class="text-sm"><strong>주소:</strong> ${business.address}</p>
                        <p class="text-sm"><strong>업종:</strong> ${business.category}</p>
                        <p class="text-sm"><strong>사용 가능 지역화폐:</strong> ${business.localCurrency}</p>
                        <p class="text-sm"><strong>제공기관:</strong> ${business.provider}</p>
                        <p class="text-sm"><strong>데이터 기준일:</strong> ${business.dataDate}</p>
                        <hr class="my-2 border-gray-600">
                        <button onclick="openReviewModal('${province}', '${city}', '${business.name.replace(/'/g, "\\'")}')" class="px-4 py-1 bg-blue-500 text-white rounded-lg mb-2">리뷰 작성</button>
                        ${googleReviewsHtml}
                        ${userReviewsHtml}
                    </div>
                `;

                const infoWindow = new google.maps.InfoWindow({ content: infoContent });
                infoWindows.push(infoWindow);

                marker.addListener("click", () => {
                    infoWindows.forEach(iw => iw.close());
                    infoWindow.open(map, marker);
                    map.panTo(marker.getPosition());
                });

                // Business item in sidebar with toggle
                const businessItem = document.createElement("div");
                businessItem.className = "p-2 bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-600 mb-1";
                const reviewId = `reviews_${province}_${city}_${business.name.replace(/[^a-zA-Z0-9]/g, "_")}`;
                businessItem.innerHTML = `
                    <h3 class="text-sm font-semibold text-white">${business.name}</h3>
                    <p class="text-xs text-gray-400">${business.address}</p>
                    <p class="text-xs text-gray-400">${business.category}</p>
                    <hr class="my-1 border-gray-600">
                    <button onclick="openReviewModal('${province}', '${city}', '${business.name.replace(/'/g, "\\'")}')" class="px-3 py-1 bg-blue-500 text-white rounded-lg text-xs mb-1">리뷰 작성</button>
                    <button onclick="toggleReviews('${reviewId}')" class="px-3 py-1 bg-gray-600 text-white rounded-lg text-xs mb-1">리뷰 보기/숨기기</button>
                    <div id="${reviewId}" class="hidden">
                        ${googleReviewsHtml}
                        ${userReviewsHtml}
                    </div>
                `;
                businessItem.addEventListener("click", () => {
                    infoWindows.forEach(iw => iw.close());
                    infoWindow.open(map, marker);
                    map.panTo(marker.getPosition());
                });
                businessList.appendChild(businessItem);
            });

            // Search functionality
            document.getElementById("searchInput").addEventListener("input", (e) => {
                const searchTerm = e.target.value.toLowerCase();
                businessList.innerHTML = "";
                businesses.forEach((business, index) => {
                    if (business.name.toLowerCase().includes(searchTerm)) {
                        // Prepare Google reviews HTML for search
                        let googleReviewsHtml = business.googleReviews.length > 0
                            ? `<h3 class="text-md font-semibold mb-2 text-white">Google 리뷰</h3>` +
                              business.googleReviews.map(review => `
                                <h5 class="text-sm text-gray-300 mb-1">
                                    <span class="text-yellow-400">${"★".repeat(review.rating)}${"☆".repeat(5 - review.rating)}</span>
                                    <span class="ml-2">${review.rating}.0</span> - 
                                    "${truncateText(review.text)}" (Google - ${review.author})
                                </h5>
                              `).join("")
                            : `<h3 class="text-md font-semibold mb-2 text-white">Google 리뷰</h3><p class="text-sm text-gray-300">Google 리뷰가 없습니다.</p>`;

                        // Prepare User reviews HTML for search
                        let userReviewsHtml = business.userReviews.length > 0
                            ? `<h3 class="text-md font-semibold mb-2 mt-2 text-white">사용자 리뷰</h3>` +
                              business.userReviews.map(review => `
                                <h5 class="text-sm text-gray-300 mb-1">
                                    <span class="text-yellow-400">${"★".repeat(review.rating)}${"☆".repeat(5 - review.rating)}</span>
                                    <span class="ml-2">${review.rating}.0</span> - 
                                    "${truncateText(review.text)}" (User - 익명)
                                </h5>
                              `).join("")
                            : `<h3 class="text-md font-semibold mb-2 mt-2 text-white">사용자 리뷰</h3><p class="text-sm text-gray-300">사용자 리뷰가 없습니다.</p>`;

                        const reviewId = `reviews_${province}_${city}_${business.name.replace(/[^a-zA-Z0-9]/g, "_")}`;
                        const businessItem = document.createElement("div");
                        businessItem.className = "p-2 bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-600 mb-1";
                        businessItem.innerHTML = `
                            <h3 class="text-sm font-semibold text-white">${business.name}</h3>
                            <p class="text-xs text-gray-400">${business.address}</p>
                            <p class="text-xs text-gray-400">${business.category}</p>
                            <hr class="my-1 border-gray-600">
                            <button onclick="openReviewModal('${province}', '${city}', '${business.name.replace(/'/g, "\\'")}')" class="px-3 py-1 bg-blue-500 text-white rounded-lg text-xs mb-1">리뷰 작성</button>
                            <button onclick="toggleReviews('${reviewId}')" class="px-3 py-1 bg-gray-600 text-white rounded-lg text-xs mb-1">리뷰 보기/숨기기</button>
                            <div id="${reviewId}" class="hidden">
                                ${googleReviewsHtml}
                                ${userReviewsHtml}
                            </div>
                        `;
                        businessItem.addEventListener("click", () => {
                            infoWindows.forEach(iw => iw.close());
                            infoWindows[index].open(map, map.markers[index]);
                            map.panTo(map.markers[index].getPosition());
                        });
                        businessList.appendChild(businessItem);
                    }
                });
            });
        }

        // Review modal functions
        function openReviewModal(province, city, businessName) {
            const modal = document.getElementById("reviewModal");
            modal.classList.remove("hidden");
            document.getElementById("submitReview").dataset.province = province;
            document.getElementById("submitReview").dataset.city = city;
            document.getElementById("submitReview").dataset.businessName = businessName;
        }

        function closeReviewModal() {
            const modal = document.getElementById("reviewModal");
            modal.classList.add("hidden");
            document.getElementById("reviewRating").value = "5";
            document.getElementById("reviewText").value = "";
        }

        function submitReview(province, city, businessName) {
            const rating = parseInt(document.getElementById("reviewRating").value);
            const text = document.getElementById("reviewText").value.trim() || "리뷰 내용 없음";
            console.log(`Submitting review: province=${province}, city=${city}, businessName=${businessName}, rating=${rating}, text=${text}`);
            const review = {
                rating: rating,
                text: text,
                author: "익명",
                source: "User"
            };
            saveUserReview(province, city, businessName, review);
            closeReviewModal();
            // Reload map to reflect new review
            const category = document.getElementById("categorySelect").value;
            loadCityMap(province, city, category);
        }

        // Toggle reviews visibility
        function toggleReviews(reviewId) {
            const reviewDiv = document.getElementById(reviewId);
            reviewDiv.classList.toggle("hidden");
        }

        // Event listeners for modal
        document.getElementById("cancelReview").addEventListener("click", closeReviewModal);
        document.getElementById("submitReview").addEventListener("click", () => {
            const province = document.getElementById("submitReview").dataset.province;
            const city = document.getElementById("submitReview").dataset.city;
            const businessName = document.getElementById("submitReview").dataset.businessName;
            submitReview(province, city, businessName);
        });

        // Initialize empty map and load categories
        window.init = function() {
            map = initEmptyMap();
            populateCategories();
        };

        // Populate cities based on province
        async function populateCities(province) {
            const citySelect = document.getElementById("citySelect");
            citySelect.innerHTML = "<option value=''>시군구 선택</option>";
            citySelect.disabled = !province;
            const categorySelect = document.getElementById("categorySelect");
            categorySelect.disabled = !province;

            if (!province) return;

            try {
                const response = await fetch(`split_json/${province}.json`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                if (!data.records || !Array.isArray(data.records)) {
                    throw new Error("잘못된 데이터 형식: 'records' 배열 없음");
                }
                const uniqueCities = [...new Set(data.records.map(record => record["시군구명"]))].filter(city => city);
                uniqueCities.forEach(city => {
                    const option = document.createElement("option");
                    option.value = city;
                    option.textContent = city;
                    citySelect.appendChild(option);
                });
            } catch (error) {
                console.error('시/도 데이터 로드 오류:', error);
            }
        }

        // Event listeners
        document.getElementById("provinceSelect").addEventListener("change", (e) => {
            const province = e.target.value;
            populateCities(province);
            const citySelect = document.getElementById("citySelect");
            citySelect.value = "";
            const categorySelect = document.getElementById("categorySelect");
            categorySelect.value = "all";
            categorySelect.disabled = !province;
            const businessList = document.getElementById("businessList");
            businessList.innerHTML = "";
            if (map.markers) map.markers.forEach(marker => marker.setMap(null));
            map.markers = [];
        });

        document.getElementById("citySelect").addEventListener("change", (e) => {
            const province = document.getElementById("provinceSelect").value;
            const city = e.target.value;
            const category = document.getElementById("categorySelect").value;
            loadCityMap(province, city, category);
        });

        document.getElementById("categorySelect").addEventListener("change", (e) => {
            const province = document.getElementById("provinceSelect").value;
            const city = document.getElementById("citySelect").value;
            const category = e.target.value;
            if (province && city) {
                loadCityMap(province, city, category);
            }
        });
    </script>

    <!-- Load Google Maps JavaScript API with Places library -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDkrKNG7uHZAIid7yg1nUnRA4K25PPKubA&callback=init&libraries=places" loading="async"></script>
</body>
</html>